# å…«è‚¡æ–‡-4

## interfaceç›¸å…³

### 1.Go è¯­è¨€ä¸é¸­å­ç±»å‹çš„å…³ç³»

> **ä»€ä¹ˆæ˜¯é¸­å­ç±»å‹ï¼Ÿ**
>
> > ã€Œå¦‚æœå®ƒèµ°èµ·æ¥åƒé¸­å­ï¼Œå«èµ·æ¥ä¹Ÿåƒé¸­å­ï¼Œé‚£å®ƒå°±æ˜¯é¸­å­ã€‚ã€
>
> è¿™å¥è¯ä»£è¡¨äº†ä¸€ç§**åŠ¨æ€è¯­è¨€çš„æ€ç»´æ–¹å¼**ï¼š
> å¯¹è±¡**ä¸éœ€è¦æ˜¾ç¤ºå£°æ˜ç±»å‹**ï¼Œåªè¦å®ƒ**å…·æœ‰æŸäº›æ–¹æ³•æˆ–å±æ€§**ï¼Œå°±å¯ä»¥è¢«å½“ä½œæŸä¸ªç±»å‹ä½¿ç”¨
>
> **Go æ˜¯é™æ€è¯­è¨€ï¼Œæ€ä¹ˆæ”¯æŒé¸­å­ç±»å‹çš„å‘¢ï¼Ÿ**
>
> 1. **æ¥å£æ˜¯éšå¼å®ç°çš„**
>
> Go ä¸è¦æ±‚ä½ æ˜¾ç¤ºå£°æ˜â€œæˆ‘å®ç°äº†æŸä¸ªæ¥å£â€ï¼Œ**åªè¦ä½ å®ç°äº†æ¥å£ä¸­æ‰€æœ‰çš„æ–¹æ³•ï¼Œä½ å°±è‡ªåŠ¨å®ç°äº†è¯¥æ¥å£**ã€‚
>
> ```
> goå¤åˆ¶ç¼–è¾‘type Speaker interface {
>     Speak()
> }
> 
> type Cat struct{}
> 
> func (c Cat) Speak() {
>     fmt.Println("Meow~")
> }
> 
> // æ²¡æœ‰å£°æ˜ "Cat implements Speaker"ï¼Œä½†ç¼–è¯‘å™¨çŸ¥é“å®ƒå¯ä»¥ï¼
> ```
>
> è¿™å°±éå¸¸ç¬¦åˆé¸­å­ç±»å‹çš„æ€æƒ³äº†å¯¹ä¸å¯¹ï¼ğŸ±âœ¨
>
> > â¤ â€œå®ƒèƒ½ Speak()ï¼Œé‚£å®ƒå°±å¯ä»¥å½“ä½œ Speaker æ¥ç”¨ï¼â€
>
> ------
>
> 2. **æ¥å£å˜é‡å¯ä»¥æ¥æ”¶ä»»ä½•â€œè¡Œä¸ºä¸€è‡´â€çš„ç±»å‹**
>
> ```
> goå¤åˆ¶ç¼–è¾‘func makeItTalk(s Speaker) {
>     s.Speak()
> }
> 
> makeItTalk(Cat{}) // OKï¼
> ```
>
> **ç¼–è¯‘å™¨åªæ£€æŸ¥â€œä½ æœ‰æ²¡æœ‰å®ç° `Speak()`â€ï¼Œè€Œä¸åœ¨ä¹ä½ æ˜¯ä»€ä¹ˆâ€œç§ç±»â€ï¼ˆCatã€Dogã€Robotï¼‰ã€‚**
>
> è¿™å’ŒåŠ¨æ€è¯­è¨€çš„é¸­å­ç±»å‹æ€æƒ³é«˜åº¦å¥‘åˆï½
> **åªçœ‹â€œè¡Œä¸ºâ€ï¼Œä¸çœ‹â€œè¡€ç»Ÿâ€ï¼**

**æ€»ç»“ï¼š**

é¸­å­ç±»å‹æ˜¯ä¸€ç§åŠ¨æ€è¯­è¨€çš„é£æ ¼ï¼Œåœ¨è¿™ç§é£æ ¼ä¸­ï¼Œ**ä¸€ä¸ªå¯¹è±¡æœ‰æ•ˆçš„è¯­ä¹‰ï¼Œä¸æ˜¯ç”±ç»§æ‰¿è‡ªç‰¹å®šçš„ç±»æˆ–å®ç°ç‰¹å®šçš„æ¥å£ï¼Œè€Œæ˜¯ç”±å®ƒ"å½“å‰æ–¹æ³•å’Œå±æ€§çš„é›†åˆ"å†³å®šã€‚**

Go ä½œä¸ºä¸€ç§é™æ€è¯­è¨€ï¼Œé€šè¿‡æ¥å£å®ç°äº† é¸­å­ç±»å‹ï¼Œå®é™…ä¸Šæ˜¯ Go çš„ç¼–è¯‘å™¨åœ¨å…¶ä¸­ä½œäº†éšåŒ¿çš„è½¬æ¢å·¥ä½œã€‚



### 2.å€¼æ¥æ”¶è€…å’ŒæŒ‡é’ˆæ¥æ”¶è€…çš„åŒºåˆ«

#### å€¼æ¥æ”¶è€… vs æŒ‡é’ˆæ¥æ”¶è€…ï¼ˆå€¼è°ƒç”¨å’ŒæŒ‡é’ˆè°ƒç”¨ï¼‰

| **è°ƒç”¨è€…ç±»å‹ï¼¼æ¥æ”¶è€…ç±»å‹** | **å€¼æ¥æ”¶è€…ï¼ˆfunc (t T) Methodï¼‰** | **æŒ‡é’ˆæ¥æ”¶è€…ï¼ˆfunc (t \*T) Methodï¼‰** |
| -------------------------- | --------------------------------- | ------------------------------------- |
| **å€¼è°ƒç”¨ï¼ˆå˜é‡æ˜¯ Tï¼‰**     | âœ… æ‹·è´å‰¯æœ¬è°ƒç”¨ï¼ˆæ­£å¸¸è°ƒç”¨ï¼‰        | âœ… è‡ªåŠ¨å–åœ°å€è°ƒç”¨ï¼ˆç¼–è¯‘å™¨è¯­æ³•ç³–ï¼‰      |
| **æŒ‡é’ˆè°ƒç”¨ï¼ˆå˜é‡æ˜¯ \*Tï¼‰** | âœ… è‡ªåŠ¨è§£å¼•ç”¨è°ƒç”¨ï¼ˆç¼–è¯‘å™¨è¯­æ³•ç³–ï¼‰  | âœ… æŒ‡é’ˆç›´æ¥ä¼ é€’è°ƒç”¨ï¼ˆä¿®æ”¹ç”Ÿæ•ˆï¼‰        |

ğŸŒ¼ ç¼–è¯‘å™¨èƒŒåçš„â€œé­”æ³•â€

- **å€¼æ¥æ”¶è€…çš„æ–¹æ³•**ï¼šè‡ªåŠ¨æ”¯æŒæŒ‡é’ˆè°ƒç”¨ï¼ˆ`(*t).Method()` è‡ªåŠ¨å˜ `t.Method()`ï¼‰ï¼š**æŒ‡é’ˆè°ƒç”¨ä¼šè‡ªåŠ¨è§£å¼•ç”¨ï¼Œæ‰€æœ‰ å€¼è°ƒç”¨å’ŒæŒ‡é’ˆè°ƒç”¨å‡å¯**
- **æŒ‡é’ˆæ¥æ”¶è€…çš„æ–¹æ³•**ï¼šä¸ä¼šè‡ªåŠ¨æ”¯æŒå€¼è°ƒç”¨ï¼Œå› ä¸ºå€¼æ‹·è´åå°±æ— æ³•ä¿®æ”¹åŸå§‹å¯¹è±¡å•¦ï¼š**å€¼è°ƒç”¨ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å–åœ°å€ï¼Œå®è´¨ä¸ºæŒ‡é’ˆè°ƒç”¨**

**ğŸ“ æ‰€ä»¥è®°ä½ï¼š**

- **å®ç°äº†å€¼æ¥æ”¶è€…æ–¹æ³• â†’ åŒæ—¶æ”¯æŒå€¼å’ŒæŒ‡é’ˆè°ƒç”¨**
- **å®ç°äº†æŒ‡é’ˆæ¥æ”¶è€…æ–¹æ³• â†’ åªæ”¯æŒæŒ‡é’ˆè°ƒç”¨**

####  ä½•æ—¶ç”¨å€¼æ¥æ”¶è€…ï¼Ÿä½•æ—¶ç”¨æŒ‡é’ˆæ¥æ”¶è€…ï¼Ÿ

âœ… ç”¨å€¼æ¥æ”¶è€…çš„åœºæ™¯ï¼š

1. **æ–¹æ³•ä¸éœ€è¦ä¿®æ”¹æ¥æ”¶è€…**
2. æ¥æ”¶è€…æ˜¯â€œè½»é‡çº§â€æˆ–â€œåŸå§‹æœ¬è´¨â€ç»“æ„ä½“ï¼ˆintã€stringã€sliceã€mapã€chanã€interface ç­‰ï¼‰
3. ç±»å‹å€¼å¤åˆ¶å¼€é”€å¾ˆå°ï¼Œç»“æ„ä¸å¤æ‚

âœ… ç”¨æŒ‡é’ˆæ¥æ”¶è€…çš„åœºæ™¯ï¼š

1. **æ–¹æ³•éœ€è¦ä¿®æ”¹æ¥æ”¶è€…çš„å€¼ï¼ˆç±»ä¼¼â€œå¼•ç”¨ä¼ é€’â€ï¼‰**
2. æ¥æ”¶è€…æ˜¯å¤§å‹ç»“æ„ä½“ï¼Œå¤åˆ¶å¼€é”€å¤§
3. æ¥æ”¶è€…ä¸æ˜¯å®‰å…¨å¤åˆ¶çš„ç±»å‹ï¼Œéœ€è¦ä¿æŒå”¯ä¸€æ€§ï¼ˆæ¯”å¦‚ os.Fileï¼‰



### 3.iface å’Œ eface çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ

|                | `eface`ï¼ˆç©ºæ¥å£ `interface{}`ï¼‰ | `iface`ï¼ˆå¸¦æ–¹æ³•çš„æ¥å£ï¼‰                         |
| -------------- | ------------------------------- | ----------------------------------------------- |
| æ˜¯å¦å«æœ‰æ–¹æ³•   | âŒ å¦                            | âœ… æ˜¯                                            |
| ç±»å‹ç»“æ„ä½“å­—æ®µ | `_type *_type`                  | `tab *itab`                                     |
| æ–¹æ³•è¡¨         | æ²¡æœ‰                            | æœ‰ `fun []uintptr`ï¼ˆå˜é•¿ï¼‰                      |
| ç±»å‹ä¿¡æ¯       | `_type` æŒ‡å‘å…·ä½“ç±»å‹å…ƒä¿¡æ¯      | `itab._type` æ˜¯å…·ä½“ç±»å‹ `itab.inter` æ˜¯æ¥å£ç±»å‹ |
| æ•°æ®æŒ‡é’ˆ       | `data unsafe.Pointer`           | åŒæ ·æ˜¯ `data unsafe.Pointer`                    |
| èµ‹å€¼å¼€é”€       | ä½ï¼ˆåªåšç±»å‹&æŒ‡é’ˆè®°å½•ï¼‰         | é«˜ï¼ˆéœ€æ„å»ºæˆ–ç¼“å­˜ itabï¼‰                         |
| é€‚ç”¨åœºæ™¯       | ä»»æ„ç±»å‹å­˜å…¥ interface{}        | æ˜ç¡®æ¥å£ç±»å‹åŠå…¶æ–¹æ³•è°ƒ                          |

#### `iface` å¸¦æ–¹æ³•çš„æ¥å£

```go
type iface struct {
    tab  *itab
    data unsafe.Pointer
}

type itab struct {
    inter  *interfacetype
    _type  *_type
    link   *itab
    hash   uint32 // copy of _type.hash. Used for type switches.
    bad    bool   // type does not implement interface
    inhash bool   // has this itab been added to hash?
    unused [2]byte
    fun    [1]uintptr // variable sized
}
```

> `itab.fun` ä¸ºä»€ä¹ˆæ˜¯ `[1]uintptr`ï¼Ÿ
>
> è¿™æ˜¯ Go çš„ä¸€ç§ trick å“¦ï½å…¶å®å®ƒä¸æ˜¯å›ºå®šé•¿åº¦ä¸º 1ï¼Œè€Œæ˜¯**é€šè¿‡åº•å±‚å®ç°ã€å˜é•¿ç»“æ„ã€‘**ï¼Œåé¢çš„å†…å­˜ç©ºé—´é‡Œç´§æ¥ç€å°±æ˜¯æ›´å¤šæ–¹æ³•çš„åœ°å€ï¼Œæ‰€ä»¥è®¿é—®ç¬¬ 2ã€ç¬¬ 3 ä¸ªæ–¹æ³•æ—¶ï¼Œæ˜¯é€šè¿‡ `fun[1]`ã€`fun[2]`... ä¾æ¬¡åç§»åœ°å€æ‹¿åˆ°çš„

```go
ifaceï¼ˆå«æ–¹æ³•æ¥å£ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tab        â”‚â”€â”€â”€â”€â–¶ itab {
â”‚            â”‚        inter  â–¶ æ¥å£ç±»å‹ï¼ˆinterfacetype å®šä¹‰ï¼‰
â”‚            â”‚        _type  â–¶ å®ä½“ç±»å‹ï¼ˆconcrete typeï¼‰
â”‚            â”‚        fun[]  â–¶ æ–¹æ³•åœ°å€åˆ—è¡¨ï¼ˆæ–¹æ³•è¡¨ï¼‰
â”‚            â”‚      }
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ data       â”‚â”€â”€â”€â”€â–¶ å®é™…æ•°æ®å€¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
type interfacetype struct {
    typ     _type
    pkgpath name
    mhdr    []imethod
}
//å®ƒåŒ…è£…äº† _type ç±»å‹ï¼Œ_type å®é™…ä¸Šæ˜¯æè¿° Go è¯­è¨€ä¸­å„ç§æ•°æ®ç±»å‹çš„ç»“æ„ä½“ã€‚æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œè¿™é‡Œè¿˜åŒ…å«ä¸€ä¸ª mhdr å­—æ®µï¼Œè¡¨ç¤ºæ¥å£æ‰€å®šä¹‰çš„å‡½æ•°åˆ—è¡¨ï¼Œ pkgpath è®°å½•å®šä¹‰äº†æ¥å£çš„åŒ…åã€‚
```

> **è¡¥å……ï¼šitab æ˜¯æ€ä¹ˆç”Ÿæˆçš„ï¼Ÿ**
>
> å½“ä½ å°†æŸä¸ªå€¼èµ‹ç»™æ¥å£å˜é‡æ—¶ï¼ŒGo ä¼šï¼š
>
> 1. æ£€æŸ¥è¯¥ç±»å‹æ˜¯å¦å®ç°äº†æ¥å£çš„å…¨éƒ¨æ–¹æ³•ï¼›
> 2. å¦‚æœå®ç°äº†ï¼Œå°è¯•ä»ç¼“å­˜ä¸­è·å–ç°æˆçš„ `itab`ï¼›
> 3. å¦‚æœæ²¡æœ‰ï¼Œå°±åˆ›å»ºæ–°çš„ `itab`ï¼Œå°†å…¶å­˜å…¥å“ˆå¸Œè¡¨ä¸­ï¼ˆå­—æ®µ `inhash` è¡¨ç¤ºæ˜¯å¦å·²å…¥è¡¨ï¼‰ï¼›
> 4. æŠŠå®ƒèµ‹å€¼ç»™æ¥å£å˜é‡çš„ `tab` å­—æ®µã€‚



#### `eface` ç©ºæ¥å£

```go
type eface struct {
    _type *_type
    data  unsafe.Pointer
}
```

```plain
efaceï¼ˆinterface{}ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _type      â”‚â”€â”€â”€â”€â–¶ ç±»å‹æè¿°ä¿¡æ¯ï¼ˆ_typeï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ data       â”‚â”€â”€â”€â”€â–¶ å®é™…æ•°æ®å€¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```



### 4.æ¥å£çš„åŠ¨æ€ç±»å‹å’ŒåŠ¨æ€å€¼

ä»æºç é‡Œå¯ä»¥çœ‹åˆ°ï¼š`iface`åŒ…å«ä¸¤ä¸ªå­—æ®µï¼štab æ˜¯æ¥å£è¡¨æŒ‡é’ˆï¼ŒæŒ‡å‘ç±»å‹ä¿¡æ¯ï¼›data æ˜¯æ•°æ®æŒ‡é’ˆï¼Œåˆ™æŒ‡å‘å…·ä½“çš„æ•°æ®ã€‚å®ƒä»¬åˆ†åˆ«è¢«ç§°ä¸ºåŠ¨æ€ç±»å‹å’ŒåŠ¨æ€å€¼ã€‚è€Œæ¥å£å€¼åŒ…æ‹¬åŠ¨æ€ç±»å‹å’ŒåŠ¨æ€å€¼ã€‚  

#### æ¥å£å€¼å’Œ `nil` çš„å¯¹æ¯”é—®é¢˜

```go
var c Coder = g // g æ˜¯ä¸€ä¸ª nil çš„ *Gopher
```

æ­¤æ—¶çš„ `c` å®é™…ä¸Šæ˜¯ï¼š

- `itab != nil`ï¼ˆå› ä¸ºç±»å‹å·²ç»ç¡®å®šæ˜¯ `*Gopher`ï¼‰
- `data == nil`ï¼ˆå› ä¸º g æ˜¯ nil æŒ‡é’ˆï¼‰

æ‰€ä»¥ï¼š

```go
c == nil // âŒ falseï¼Œå› ä¸º itab != nil
```

 **åªæœ‰ `itab == nil` ä¸” `data == nil`ï¼Œæ¥å£å€¼æ‰çœŸçš„ç­‰äº `nil`**



### 5.ç¼–è¯‘å™¨è‡ªåŠ¨æ£€æµ‹ç±»å‹æ˜¯å¦å®ç°æ¥å£?

```go
type X interface {
    Speak() string
}
type T struct{}    // å®šä¹‰ä¸€ä¸ªç±»å‹ T
var _ X = T{}     // åˆ›å»ºåŒ¿åæ¥å£å˜é‡èµ‹å€¼ç»™Tï¼Œåˆ¤æ–­ T æ˜¯å¦å®ç°äº†æ¥å£ X
//// ç¼–è¯‘é”™è¯¯ï¼šcannot use T{} (type T) as type X in assignment: T does not implement X (missing Speak method)
```



### 6.**æ¥å£çš„æ„é€ è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ** --- å³ 8. æ¥å£è½¬æ¢åŸç†

1. åˆ›å»ºäº†ä¸€ä¸ª `Student{age: 18}` å˜é‡ï¼›
2. æŸ¥æ‰¾å¹¶è·å– `go.itab."".Student,"".<æŒ‡å®šæ¥å£>`ï¼›
3. å°† itab åœ°å€å’Œæ•°æ®åœ°å€ä½œä¸ºå‚æ•°è°ƒç”¨ `runtime.convT2I64`ï¼Œæ„é€ å‡ºæ¥å£å€¼



### 7.ç±»å‹è½¬æ¢å’Œæ–­è¨€çš„åŒºåˆ«

#### ç±»å‹è½¬åŒ–

```go
func main() {
    var i int = 9
    var f float64

    // int è½¬ float64
    f = float64(i)
    fmt.Printf("%T, %v\n", f, f) // float64, 9

    // float64 è½¬ intï¼ˆä¼šèˆå¼ƒå°æ•°éƒ¨åˆ†ï¼‰
    f = 10.8
    a := int(f)
    fmt.Printf("%T, %v\n", a, a) // int, 10
}
```

- åªèƒ½ç”¨äº**åŸºæœ¬ç±»å‹ä¹‹é—´çš„è½¬æ¢**ï¼ˆintã€floatã€string ç­‰ï¼‰ï¼›
- ç¼–è¯‘æ—¶æ£€æŸ¥ç±»å‹æ˜¯å¦å…¼å®¹ï¼›
- å±äºâ€œ**æ˜¾ç¤ºè½¬æ¢**â€ï¼ŒGo ä¸æ”¯æŒéšå¼è½¬æ¢å“¦



#### ç±»å‹æ–­è¨€

```go
type Student struct {
    Name string
    Age  int
}

func main() {
    var i interface{} = Student{"Alice", 20}

    s, ok := i.(Student)  // å®‰å…¨æ–­è¨€
    if ok {
        fmt.Println("æ–­è¨€æˆåŠŸï¼š", s)
    } else {
        fmt.Println("æ–­è¨€å¤±è´¥")
    }

    // éå®‰å…¨æ–­è¨€ï¼ˆå¯èƒ½ panicï¼‰
    s2 := i.(Student)
    fmt.Println("éå®‰å…¨æ–­è¨€ï¼š", s2)
}
```

- åªèƒ½å¯¹ `interface{}`ï¼ˆæ¥å£ç±»å‹ï¼‰ä½¿ç”¨ï¼›
- è¿è¡Œæ—¶æ‰åˆ¤æ–­æ˜¯å¦æˆåŠŸï¼ˆ**è¿è¡Œæ—¶æœºåˆ¶**ï¼‰ï¼›
- å¸¸ç”¨äºåˆ¤æ–­æ¥å£åº•å±‚æ•°æ®ç±»å‹ï¼›
- å¯é…åˆ `switch` åšç±»å‹åˆ†æ”¯åˆ¤æ–­ã€‚

**æ€»ç»“ï¼š**

| ç‰¹ç‚¹         | ç±»å‹è½¬æ¢           | ç±»å‹æ–­è¨€                     |
| ------------ | ------------------ | ---------------------------- |
| æ“ä½œå¯¹è±¡     | åŸºæœ¬ç±»å‹å˜é‡       | æ¥å£ç±»å‹å˜é‡ï¼ˆinterface{}ï¼‰  |
| ç±»å‹å…³ç³»     | ç±»å‹ä¹‹é—´éœ€å…¼å®¹     | åˆ¤æ–­æ¥å£åº•å±‚æ˜¯å¦ä¸ºæŸç§ç±»å‹   |
| ç¼–è¯‘é˜¶æ®µ     | ç¼–è¯‘æ—¶æ£€æŸ¥         | è¿è¡Œæ—¶åˆ¤æ–­                   |
| æˆåŠŸå¤±è´¥å¤„ç† | ç›´æ¥å¤±è´¥ï¼Œç¼–è¯‘ä¸è¿‡ | å¯ä»¥ç”¨ `ok` åˆ¤æ–­æ˜¯å¦æ–­è¨€æˆåŠŸ |
| å¸¸è§ç”¨é€”     | ç±»å‹é—´çš„æ•°å€¼è½¬æ¢   | æ¥å£ä¸­çš„å…·ä½“ç±»å‹è¯†åˆ«         |



### 8.[æ¥å£è½¬æ¢çš„åŸç†](http://golang.design/go-questions/interface/convert/)

> é€šè¿‡å‰é¢æåˆ°çš„ iface çš„æºç å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šå®ƒåŒ…å«æ¥å£çš„ç±»å‹ interfacetype å’Œ å®ä½“ç±»å‹çš„ç±»å‹ _typeï¼Œè¿™ä¸¤è€…éƒ½æ˜¯ iface çš„å­—æ®µ itab çš„æˆå‘˜ã€‚ä¹Ÿå°±æ˜¯è¯´ç”Ÿæˆä¸€ä¸ª itab åŒæ—¶éœ€è¦æ¥å£çš„ç±»å‹å’Œå®ä½“çš„ç±»å‹ã€‚  
> <interface ç±»å‹ï¼Œ å®ä½“ç±»å‹> ->itable  

**ä»€ä¹ˆæ˜¯æ¥å£è½¬æ¢ï¼š**

å½“åˆ¤å®šä¸€ç§ç±»å‹æ˜¯å¦æ»¡è¶³æŸä¸ªæ¥å£æ—¶ï¼Œ**Go ä½¿ç”¨ç±»å‹çš„æ–¹æ³•é›†å’Œæ¥å£æ‰€éœ€è¦çš„æ–¹æ³•é›†è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœç±»å‹çš„æ–¹æ³•é›†å®Œå…¨åŒ…å«æ¥å£çš„æ–¹æ³•é›†ï¼Œåˆ™å¯è®¤ä¸ºè¯¥ç±»å‹å®ç°äº†è¯¥æ¥å£ã€‚ï¼ˆé¸­å­ç±»å‹ï¼‰**  
ä¾‹å¦‚æŸç±»å‹æœ‰ m ä¸ªæ–¹æ³•ï¼ŒæŸæ¥å£æœ‰ n ä¸ªæ–¹æ³•ï¼Œåˆ™å¾ˆå®¹æ˜“çŸ¥é“è¿™ç§åˆ¤å®šçš„æ—¶é—´å¤æ‚åº¦ä¸º O(mn)ï¼ŒGo ä¼šå¯¹æ–¹æ³•é›†çš„å‡½æ•°æŒ‰ç…§å‡½æ•°åçš„å­—å…¸åºè¿›è¡Œæ’åºï¼Œæ‰€ä»¥å®é™…çš„æ—¶é—´å¤æ‚åº¦ä¸º O(m+n)ã€‚  

**å„ç§å½¢å¼è½¬åŒ–çš„åŸç†ï¼š**

è¿™é‡Œæˆ‘ä»¬æ¥æ¢ç´¢å°†ä¸€ä¸ªæ¥å£è½¬æ¢ç»™å¦å¤–ä¸€ä¸ªæ¥å£èƒŒåçš„åŸç†ï¼Œå½“ç„¶ï¼Œèƒ½è½¬æ¢çš„åŸå› å¿…ç„¶æ˜¯ç±»å‹å…¼å®¹ã€‚

1. **å…·ä½“ç±»å‹è½¬ç©ºæ¥å£æ—¶**ï¼Œ_type å­—æ®µç›´æ¥å¤åˆ¶æºç±»å‹çš„ _typeï¼›è°ƒç”¨ mallocgc è·å¾—ä¸€å—æ–°å†…å­˜ï¼ŒæŠŠå€¼å¤åˆ¶è¿›å»ï¼Œdata å†æŒ‡å‘è¿™å—æ–°å†…å­˜ã€‚

   > å‡è®¾æˆ‘ä»¬æœ‰ `var i interface{} = 123`
   >
   > åº•å±‚åšçš„äº‹å¦‚ä¸‹ï¼š
   >
   > 1. å°† `123` çš„ç±»å‹ä¿¡æ¯ï¼ˆä¾‹å¦‚ `*_type{}`ï¼‰èµ‹ç»™ `eface._type`
   >
   > 2. è°ƒç”¨ `mallocgc` å¼€è¾Ÿå †å†…å­˜ï¼Œå¤åˆ¶ä¸€ä¸ª `123` çš„å‰¯æœ¬è¿‡å»
   >
   >    > `mallocgc`ä¸€å®šåœ¨å †ä¸Šå¼€è¾Ÿå†…å­˜ï¼Œä½†ç¼–è¯‘æ—¶åœ¨å †ä¸Šè¿˜æ˜¯æ ˆä¸Šï¼šå–å†³äºé€ƒé€¸åˆ†æï¼ˆ**è‡ªåŠ¨å†…å­˜æœºåˆ¶**ï¼‰
   >
   > 3. `eface.data` æŒ‡å‘è¿™ä¸ªå†…å­˜åœ°å€
   >
   > > ğŸ“Œ æ³¨æ„ï¼šå€¼æ˜¯**å¤åˆ¶**è¿›å †å†…å­˜çš„ï¼ŒåŸå€¼æ”¹å˜ä¸ä¼šå½±å“ interface ä¸­çš„å€¼ã€‚

2. **å…·ä½“ç±»å‹è½¬éç©ºæ¥å£æ—¶**ï¼Œå…¥å‚ tab æ˜¯ç¼–è¯‘å™¨åœ¨ç¼–è¯‘é˜¶æ®µé¢„å…ˆç”Ÿæˆå¥½çš„ï¼Œæ–°æ¥å£ tab å­—æ®µç›´æ¥æŒ‡å‘å…¥å‚ tab æŒ‡å‘çš„ itabï¼›è°ƒç”¨ mallocgc è·å¾—ä¸€å—æ–°å†…å­˜ï¼ŒæŠŠå€¼å¤åˆ¶è¿›å»ï¼Œdata å†æŒ‡å‘è¿™å—æ–°å†…å­˜ã€‚

   > ```go
   > type Stringer interface {
   >     String() string
   > }
   > 
   > var s Stringer = MyStruct{}
   > ```
   >
   > è¿™ä¸ªæ—¶å€™ï¼š
   >
   > 1. ç¼–è¯‘å™¨ **é¢„å…ˆç”Ÿæˆ** ä¸€ä¸ª `itab`ï¼šåŒ…å«
   >    - `_type`ï¼šå…·ä½“ç±»å‹ï¼ˆMyStructï¼‰
   >    - `interface type`ï¼šæ¥å£ç±»å‹ï¼ˆStringerï¼‰
   >    - **æ–¹æ³•è·³è½¬è¡¨ï¼šMyStruct çš„æ–¹æ³•å¦‚ä½•å®ç° Stringer çš„æ–¹æ³•**
   > 2. æ„é€  `iface` ç»“æ„ï¼š
   >    - `tab` æŒ‡å‘ `itab`
   >    - `data` æŒ‡å‘å…·ä½“æ•°æ®ï¼ˆé€šè¿‡ `mallocgc` æ‹·è´ï¼‰

3. è€Œ**å¯¹äºæ¥å£è½¬æ¥å£**ï¼Œitab è°ƒç”¨ getitab å‡½æ•°è·å–ã€‚åªç”¨ç”Ÿæˆä¸€æ¬¡ï¼Œä¹‹åç›´æ¥ä» hash è¡¨ä¸­è·å–ã€‚

   > ```go
   > type A interface { M() }
   > type B interface { M(); N() }
   > 
   > var a A = T{}  // T å®ç°äº† M() å’Œ N()
   > var b B = a    // è¿™å°±æ˜¯æ¥å£è½¬æ¥å£
   > ```
   >
   > åº•å±‚å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ
   >
   > 1. Go ä¼šå°è¯•åœ¨è¿è¡Œæ—¶è°ƒç”¨ `getitab`ï¼š
   >    - ä¼ å…¥ï¼šç›®æ ‡æ¥å£ç±»å‹ï¼ˆBï¼‰ã€æºæ¥å£çš„ `_type`ï¼ˆTï¼‰ã€æ˜¯å¦æ–­è¨€å®‰å…¨ï¼ˆæ˜¯å¦ panicï¼‰
   >    - è¿”å›ï¼šæ˜¯å¦å­˜åœ¨åŒ¹é…çš„ `itab`ï¼ˆå³ï¼šT æ˜¯å¦å®ç°äº† Bï¼‰
   > 2. è‹¥æ‰¾åˆ° `itab`ï¼š
   >    - ç›´æ¥æ„é€ æ–°çš„ `iface`ï¼ˆç›®æ ‡æ¥å£ï¼‰ç»“æ„ï¼š
   >      - `tab` æŒ‡å‘æ‰¾åˆ°çš„ itab
   >      - `data` å…±äº«åŸå§‹æ•°æ®æŒ‡é’ˆï¼ˆ**ä¸å¤åˆ¶æ•°æ®**ï¼‰
   > 3. è‹¥æœªæ‰¾åˆ°ï¼š
   >    - éå®‰å…¨æ–­è¨€ï¼španic
   >    - å®‰å…¨æ–­è¨€ï¼šè¿”å› `ok = false`



### 9.[å¦‚ä½•ç”¨ interface å®ç°å¤šæ€](http://golang.design/go-questions/interface/polymorphism/)

Go è¯­è¨€å¹¶æ²¡æœ‰è®¾è®¡è¯¸å¦‚è™šå‡½æ•°ã€çº¯è™šå‡½æ•°ã€ç»§æ‰¿ã€å¤šé‡ç»§æ‰¿ç­‰æ¦‚å¿µï¼Œä½†å®ƒ**é€šè¿‡æ¥å£å´éå¸¸ä¼˜é›…åœ°æ”¯æŒäº†é¢å‘å¯¹è±¡çš„ç‰¹æ€§**ã€‚  
å¤šæ€æ˜¯ä¸€ç§è¿è¡ŒæœŸçš„è¡Œä¸ºï¼Œå®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š

1. ä¸€ç§ç±»å‹å…·æœ‰å¤šç§ç±»å‹çš„èƒ½åŠ›
2. å…è®¸ä¸åŒçš„å¯¹è±¡å¯¹åŒä¸€æ¶ˆæ¯åšå‡ºçµæ´»çš„ååº”
3. ä»¥ä¸€ç§é€šç”¨çš„æ–¹å¼å¯¹å¾…ä¸ªä½¿ç”¨çš„å¯¹è±¡
4. éåŠ¨æ€è¯­è¨€å¿…é¡»é€šè¿‡ç»§æ‰¿å’Œæ¥å£çš„æ–¹å¼æ¥å®ç°

**æˆ‘ä»¬é€šè¿‡ï¼šä¸åŒç»“æ„ä½“ å®ç° åŒä¸€æ¥å£çš„æ–¹æ³• ï¼Œæ ¹æ® æ¥å£è½¬æ¢ï¼Œå®ç° åŒä¸€æ¥å£å¯¹è±¡è°ƒç”¨å¤šä¸ªç»“æ„ä½“çš„æ–¹æ³•**



## Contextç›¸å…³

### context ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ

Go çš„ `context.Context` æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒçš„å®ç°æ˜¯ä¸€ä¸ª**é“¾å¼ç»“æ„**ï¼Œå¯ä»¥åµŒå¥—å¤šä¸ªä¸Šä¸‹æ–‡ã€‚

```go
type Context interface {
    Deadline() (deadline time.Time, ok bool)
    Done() <-chan struct{}
    Err() error
    Value(key any) any
}
```

| æ–¹æ³•         | ä½œç”¨è¯´æ˜                                                     |
| ------------ | ------------------------------------------------------------ |
| `Deadline()` | è¿”å› context ä½•æ—¶ä¼šè¶…æ—¶ï¼ˆ`time.Time, bool`ï¼‰                 |
| `Done()`     | è¿”å›ä¸€ä¸ªåªè¯» channelï¼Œcontext è¢«å–æ¶ˆï¼ˆcancelï¼‰æˆ–è¶…æ—¶æ—¶ä¼šå…³é—­ |
| `Err()`      | `Done` å…³é—­åè°ƒç”¨ï¼Œè¿”å›å–æ¶ˆåŸå› ï¼ˆå¦‚ï¼šcontext.Canceled/context.DeadlineExceededï¼‰ |
| `Value()`    | ç”¨äºä» context ä¸­å–å€¼ï¼Œcontext æœ¬èº«ä¸å¯å˜ï¼ŒValue æ˜¯åç¨‹å®‰å…¨çš„ |

å®é™…å®ç°æœ‰å››ç§ç»“æ„ä½“ï¼š

- `backgroundCtx` å’Œ `todoCtx`ï¼šæœ€åº•å±‚çš„ contextï¼Œä¸å¯å–æ¶ˆï¼›
- `cancelCtx`ï¼šå¯å–æ¶ˆçš„ contextï¼Œæœ€å¸¸ç”¨ï¼›
- `timerCtx`ï¼šå¸¦è¶…æ—¶çš„ contextï¼›
- `valueCtx`ï¼šæºå¸¦å€¼çš„ contextã€‚



### contextä½¿ç”¨åœºæ™¯

âœ… 1. **è¯·æ±‚é“¾è·¯ç®¡ç† / è¶…æ—¶æ§åˆ¶**

> åœ¨ Web æœåŠ¡ä¸­ï¼Œä¸€æ¬¡è¯·æ±‚å¯èƒ½ä¼šè°ƒç”¨å¾ˆå¤šä¸‹æ¸¸æœåŠ¡ï¼Œæ¯”å¦‚ï¼šæ•°æ®åº“ã€ç¼“å­˜ã€å¤–éƒ¨ APIï¼Œ**è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆä¸€èµ·å–æ¶ˆ**ã€‚

```go
func handler(w http.ResponseWriter, r *http.Request) {
    ctx, cancel := context.WithTimeout(r.Context(), 2*time.Second)
    defer cancel()

    data, err := fetchFromAPI(ctx)
    if err != nil {
        http.Error(w, err.Error(), http.StatusRequestTimeout)
        return
    }
    w.Write(data)
}
//åˆ›å»ºå¸¦è¶…æ—¶çš„ contextï¼š
ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
defer cancel()

select {
case <-ctx.Done():
    if ctx.Err() == context.DeadlineExceeded {
        fmt.Println("æ“ä½œè¶…æ—¶")
    }
case result := <-someOperation():
    fmt.Println("æ“ä½œç»“æœ:", result)
}
//*åˆ›å»ºå¸¦å–æ¶ˆåŠŸèƒ½çš„ context
ctx, cancel := context.WithCancel(context.Background())
defer cancel()

go func() {
    // æ‰§è¡Œä¸€äº›æ“ä½œ
    // åœ¨éœ€è¦å–æ¶ˆæ“ä½œæ—¶è°ƒç”¨ cancel
    cancel()
}()

select {
case <-ctx.Done():
    fmt.Println("æ“ä½œå–æ¶ˆ")
case result := <-someOperation():
    fmt.Println("æ“ä½œç»“æœ:", result)
}
```

**é‡ç‚¹ï¼š** å¦‚æœ `fetchFromAPI` è¶…æ—¶æˆ–ç”¨æˆ·ä¸»åŠ¨å…³é—­è¿æ¥ï¼Œæ‰€æœ‰æ“ä½œéƒ½èƒ½è¢«é€šçŸ¥åˆ°ã€åŠæ—¶é€€å‡ºã€‚

------

âœ… 2. **goroutine ç®¡ç†ï¼šè®©å¤šä¸ªåç¨‹ä¸€èµ·é€€å‡º**

```go
ctx, cancel := context.WithCancel(context.Background())
go worker(ctx) // è¢«åŠ¨æ¥æ”¶å…³é—­ä¿¡å·
// ...
cancel() // å‘å‡ºä¿¡å·ï¼šæ‰€æœ‰ç›‘å¬è¿™ä¸ª ctx çš„ goroutine éƒ½èƒ½åœä¸‹æ¥
```

------

âœ… 3. **æºå¸¦è¯·æ±‚èŒƒå›´å†…çš„å…ƒæ•°æ®**

```go
ctx := context.WithValue(context.Background(), "userID", 1234)
handleBusiness(ctx)
```

è¿™æ ·ä½ åœ¨æ—¥å¿—ã€æƒé™æ ¡éªŒã€å®¡è®¡ä¸­å°±å¯ä»¥è·å–å½“å‰è¯·æ±‚çš„ç”¨æˆ· ID ç­‰ä¿¡æ¯ã€‚

æ³¨æ„âš ï¸ï¼š`context` çš„ `Value` ä¸å»ºè®®ç”¨æ¥ä¼ é€’ä¸šåŠ¡æ•°æ®ï¼Œåªé€‚åˆä¼ é€’**â€œè·¨è¶Šå±‚çº§çš„å…ƒä¿¡æ¯â€**ï¼Œæ¯”å¦‚ï¼štraceIDã€ç”¨æˆ·èº«ä»½ã€è¯­è¨€åŒºåŸŸã€‚

###  æ€»ç»“ç²¾ç‚¼ï¼š

| é¡¹ç›®           | å†…å®¹                                                         |
| -------------- | ------------------------------------------------------------ |
| ğŸ’¡ context æä¾› | å–æ¶ˆä¿¡å·ï¼ˆDoneï¼‰ã€é”™è¯¯åŸå› ï¼ˆErrï¼‰ã€è¶…æ—¶æ§åˆ¶ï¼ˆDeadlineï¼‰ã€ä¼ å€¼èƒ½åŠ›ï¼ˆValueï¼‰ |
| ğŸ§  ä¸»è¦ç±»å‹     | `Background()`ã€`TODO()`ã€`WithCancel()`ã€`WithTimeout()`ã€`WithValue()` |
| ğŸ¯ åº”ç”¨åœºæ™¯     | è¯·æ±‚è¶…æ—¶æ§åˆ¶ã€goroutine é€€å‡ºã€traceID æ—¥å¿—è¿½è¸ªã€ä¼ é€’ç”¨æˆ·èº«ä»½ä¿¡æ¯ç­‰ |
| ğŸ› ï¸ é¢è¯•å¸¸ç­”     | å®é™…é¡¹ç›®ä¸­åšè¯·æ±‚é“¾è·¯ç®¡ç†ã€traceID ä¼ é€’ã€grpc è¶…æ—¶æ§åˆ¶ã€ä»»åŠ¡é€€å‡ºé€šçŸ¥ |
